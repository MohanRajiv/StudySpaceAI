{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 79, "column": 0}, "map": {"version":3,"sources":["file:///Users/admin/Downloads/study-space-ai/client/study-space/app/api/mp4-route/route.js"],"sourcesContent":["import { GoogleAIFileManager } from \"@google/generative-ai/server\";\nimport { NextResponse } from \"next/server\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport os from \"os\";\nimport busboy from \"busboy\";\nimport { Readable } from \"stream\";\n\nconst fileManager = new GoogleAIFileManager(process.env.GEMINI_API_KEY);\n\nexport async function POST(req) {\n  let tempFilePath = \"\";\n\n  try {\n    const tempDir = os.tmpdir();\n    let mimeType = \"\";\n    let fileName = \"\";\n\n    const contentType = req.headers.get(\"content-type\") || \"\";\n    \n    if (!contentType.includes(\"multipart/form-data\")) {\n        return NextResponse.json({ error: \"Content type must be multipart/form-data\" }, { status: 400 });\n    }\n\n    const bb = busboy({ headers: { \"content-type\": contentType } });\n    \n    // Create a promise that resolves when the file is fully written to disk\n    const fileWritePromise = new Promise((resolve, reject) => {\n      bb.on(\"file\", (name, file, info) => {\n        const { filename, mimeType: mime } = info;\n        fileName = filename;\n        mimeType = mime;\n        tempFilePath = path.join(tempDir, `upload_${Date.now()}_${filename}`);\n        \n        const writeStream = fs.createWriteStream(tempFilePath);\n        file.pipe(writeStream);\n        \n        writeStream.on(\"finish\", () => {\n            resolve();\n        });\n        \n        writeStream.on(\"error\", (err) => reject(err));\n      });\n\n      bb.on(\"error\", (err) => reject(err));\n    });\n\n    // Create a promise for the busboy parsing completion\n    const bbPromise = new Promise((resolve, reject) => {\n        bb.on(\"close\", resolve);\n        bb.on(\"error\", reject);\n    });\n\n    // Convert Web ReadableStream to Node Readable and pipe to busboy\n    if (!req.body) {\n        return NextResponse.json({ error: \"No request body\" }, { status: 400 });\n    }\n    const nodeStream = Readable.fromWeb(req.body);\n    nodeStream.pipe(bb);\n\n    // Wait for both busboy to finish parsing AND the file to finish writing\n    await Promise.all([bbPromise, fileWritePromise]);\n\n    if (!tempFilePath) {\n        return NextResponse.json({ error: \"No file uploaded\" }, { status: 400 });\n    }\n\n    // Verify file exists and has size\n    const stats = fs.statSync(tempFilePath);\n    if (stats.size === 0) {\n         return NextResponse.json({ error: \"Uploaded file is empty\" }, { status: 400 });\n    }\n\n    // Validate file size (10MB limit for Next.js, 20MB for Gemini)\n    const maxSizeBytes = 10 * 1024 * 1024; // 10MB\n    if (stats.size > maxSizeBytes) {\n        // Clean up temp file\n        try {\n            if (fs.existsSync(tempFilePath)) {\n                fs.unlinkSync(tempFilePath);\n            }\n        } catch (e) {}\n        return NextResponse.json({ \n            error: `File size (${(stats.size / 1024 / 1024).toFixed(2)}MB) exceeds the 10MB limit` \n        }, { status: 400 });\n    }\n\n    // Validate MIME type - accept video files, especially MP4\n    const allowedMimeTypes = [\n        'video/mp4',\n        'video/mpeg',\n        'video/quicktime',\n        'video/x-msvideo',\n        'video/webm'\n    ];\n    \n    if (!mimeType || (!mimeType.startsWith('video/') && !allowedMimeTypes.includes(mimeType))) {\n        // Clean up temp file\n        try {\n            if (fs.existsSync(tempFilePath)) {\n                fs.unlinkSync(tempFilePath);\n            }\n        } catch (e) {}\n        return NextResponse.json({ \n            error: `Invalid file type. Please upload a video file (MP4, MOV, AVI, etc.). Received: ${mimeType || 'unknown'}` \n        }, { status: 400 });\n    }\n\n    console.log(`Uploading to Gemini: ${fileName} (${mimeType}), size: ${(stats.size / 1024 / 1024).toFixed(2)}MB`);\n\n    // Upload to Gemini\n    const uploadResult = await fileManager.uploadFile(tempFilePath, {\n      mimeType: mimeType,\n      displayName: fileName,\n    });\n\n    console.log(`Upload complete. URI: ${uploadResult.file.uri}`);\n\n    // Clean up temp file immediately after upload\n    try {\n        if (fs.existsSync(tempFilePath)) {\n            fs.unlinkSync(tempFilePath);\n        }\n    } catch (cleanupErr) {\n        console.warn(\"Failed to delete temp file:\", cleanupErr);\n    }\n\n    // Wait for processing\n    let fileRecord = await fileManager.getFile(uploadResult.file.name);\n    while (fileRecord.state === \"PROCESSING\") {\n      console.log(`Processing... Current state: ${fileRecord.state}`);\n      await new Promise((resolve) => setTimeout(resolve, 5000)); // Increase poll interval\n      fileRecord = await fileManager.getFile(uploadResult.file.name);\n    }\n\n    console.log(`Final state: ${fileRecord.state}`);\n\n    if (fileRecord.state === \"FAILED\") {\n      console.error(\"Video processing failed:\", fileRecord);\n      return NextResponse.json({ error: \"Video processing failed by Gemini\" }, { status: 500 });\n    }\n\n    return NextResponse.json({ \n      fileUri: uploadResult.file.uri, \n      mimeType: uploadResult.file.mimeType,\n      name: uploadResult.file.name\n    });\n\n  } catch (error) {\n    console.error(\"Error uploading file:\", error);\n    // Clean up on error\n    if (tempFilePath && fs.existsSync(tempFilePath)) {\n        try { fs.unlinkSync(tempFilePath); } catch (e) {}\n    }\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}